import ejs from "ejs";
import fs from "fs";
import path from "path";
import { fileURLToPath } from "url";
import { transporter } from "../utils/mailer.js";
import { GoogleGenerativeAI } from "@google/generative-ai";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const templateDir = path.join(__dirname, "../templates");

import { generateColdEmail } from "../services/ai.service.js";

export const getTemplates = (req, res) => {
  try {
    const templates = fs
      .readdirSync(templateDir)
      .filter((file) => file.endsWith(".json"))
      .map((file) => {
        const templatePath = path.join(templateDir, file);
        const templateConfig = JSON.parse(fs.readFileSync(templatePath, 'utf8'));
        return {
          name: templateConfig.name,
          description: templateConfig.description,
          variables: templateConfig.variables,
          subject: templateConfig.subject
        };
      });
    res.json({ templates });
  } catch (error) {
    console.error(error);
    res.status(500).json({ message: "Error reading templates" });
  }
};

export const generateEmailContent = async (req, res) => {
  try {
    const { profile, jd, instructions, recipientName, company } = req.body;
    
    if (!profile) {
      return res.status(400).json({ success: false, error: "Profile data is required" });
    }

    const emailContent = await generateColdEmail(profile, jd, instructions, recipientName, company);
    res.json({ success: true, data: emailContent });
  } catch (error) {
    console.error("Generate email error:", error);
    res.status(500).json({ success: false, error: error.message });
  }
};

export const sendEmail = async (req, res) => {
  try {
    const {
      name,
      email,
      recipientName,
      role,
      company,
      experience,
      skills,
      phoneNumber,
      refresh_token,
      customSubject,
      customBody
    } = req.body;
    const resumeFile = req.file;

    // Validate required fields
    const requiredFields = { name, email, recipientName, role, company, experience, skills, phoneNumber };
    const missingFields = Object.keys(requiredFields).filter(field => !requiredFields[field]);
    if (missingFields.length > 0) {
      return res.status(400).json({
        success: false,
        error: `Missing required fields: ${missingFields.join(', ')}`
      });
    }

    let html, subject;

    if (customSubject && customBody) {
      // Use custom content generated by AI/User
      subject = customSubject;
      html = customBody;
    } else {
      // Load template configuration (Fallback/Default behavior)
      const templateConfigPath = path.join(templateDir, "job-application.json");
      const templateConfig = JSON.parse(fs.readFileSync(templateConfigPath, 'utf8'));
      const templateData = { name, email, recipientName, role, company, experience, skills, phoneNumber };
      html = await ejs.renderFile(path.join(templateDir, `${templateConfig.name}.ejs`), templateData);
      subject = templateConfig.subject.replace('{{role}}', role).replace('{{company}}', company);
    }

    if (refresh_token) {
      // Use Gmail API
      const { google } = await import('googleapis');
      const CLIENT_ID = process.env.GOOGLE_CLIENT_ID;
      const CLIENT_SECRET = process.env.GOOGLE_CLIENT_SECRET;
      const REDIRECT_URI = process.env.GOOGLE_REDIRECT_URI;
      const oauth2Client = new google.auth.OAuth2(CLIENT_ID, CLIENT_SECRET, REDIRECT_URI);
      oauth2Client.setCredentials({ refresh_token });
      const gmail = google.gmail({ version: 'v1', auth: oauth2Client });
      
      // Construct raw message
      // Note: Simple raw string might have issues with special chars in HTML. 
      // Better to use a library or proper MIME construction, but keeping it simple as per existing pattern for now.
      // We need to ensure headers are correct.
      
      const utf8Subject = `=?utf-8?B?${Buffer.from(subject).toString('base64')}?=`;
      const messageParts = [
        `To: ${email}`,
        `Subject: ${utf8Subject}`,
        "Content-Type: text/html; charset=UTF-8",
        "MIME-Version: 1.0",
        "",
        html
      ];
      
      let rawMessage = messageParts.join("\r\n");

      // Attachments not supported in simple raw, would need MIME multipart for resume
      if (resumeFile) {
        // For demo, skip attachment if using Gmail API
        rawMessage += `\r\n\r\n[Attachment omitted in Gmail API demo]`;
      }
      const encodedMessage = Buffer.from(rawMessage).toString('base64').replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
      await gmail.users.messages.send({ userId: 'me', requestBody: { raw: encodedMessage } });
      return res.json({ success: true, message: "Email sent via Gmail API!" });
    } else {
      // Fallback to nodemailer
      const mailOptions = {
        from: process.env.EMAIL_USER,
        to: email,
        subject: subject,
        html: html,
      };
      if (resumeFile) {
        mailOptions.attachments = [{ filename: resumeFile.originalname, content: resumeFile.buffer, contentType: resumeFile.mimetype }];
      }
      const result = await transporter.sendMail(mailOptions);
      return res.json({ success: true, message: "Email sent successfully!", messageId: result.messageId });
    }
  } catch (error) {
    console.error('Email sending error:', error);
    res.status(500).json({ success: false, error: error.message });
  }
};

  export const testAI = async (req, res) => {
    try {
      // const { prompt } = req.body;
      const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);
      const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });
      console.log('AI model response:', model);
     const result = await model.generateContent("hey what is generative AI?");
     const responseText = result.response.text();
    res.json({response: responseText });
    } catch (error) {
      console.error('AI test error:', error);
      res.status(500).json({ success: false, error: error.message });
    }
  };

